"0","#| label: block01-devices-overview"
"0","#| warning: false"
"0","#| message: false"
"0",""
"0","# ============================================================"
"0","# BLOCK 01: Geräteausstattung (Stichprobenbeschreibung)"
"0","# - dev_*_time wird ausgeschlossen"
"0","# - Statuswerte werden gemäß Fragebogen (1–4) gelabelt"
"0","# - ein gemeinsamer 100%-Stacked-Plot im SURF-Style + Logo"
"0","# - Export: outputs/plots/01_01_devices_overview.png"
"0","# ============================================================"
"0",""
"0","# 0) Save-Plot Engine (konsistent, überschreibt evtl. alte Version)"
"0","save_plot <- function(plot, block, sub, slug,"
"0","                      width = 8, height = 5, dpi = 300) {"
"0","  filename <- sprintf(""%02d_%02d_%s.png"", block, sub, slug)"
"0","  path <- file.path(PLOTS_DIR, filename)"
"0",""
"0","  ggplot2::ggsave("
"0","    filename = path,"
"0","    plot = plot,"
"0","    width = width,"
"0","    height = height,"
"0","    dpi = dpi"
"0","  )"
"0","  invisible(path)"
"0","}"
"0",""
"0","# 1) Gerätevariablen: nur Inhalte (kein Timing)"
"0","device_vars <- names(daten_analysis)["
"0","  stringr::str_detect(names(daten_analysis), ""^dev_"") &"
"0","    !stringr::str_detect(names(daten_analysis), ""_time$"")"
"0","]"
"0",""
"0","if (length(device_vars) == 0) {"
"0","  stop(""Block 01: Keine inhaltlichen dev_-Variablen gefunden (ohne *_time)."")"
"0","}"
"0",""
"0","# 2) Gerätnamen (so wie im Fragebogen benannt; ggf. anpassen, falls deine Spalten anders heißen)"
"0","device_labels <- c("
"0","  dev_box     = ""Wallbox für Elektroauto"","
"0","  dev_heat    = ""Wärmepumpe"","
"0","  dev_battery = ""Batteriespeicher"","
"0","  dev_pv      = ""Photovoltaik-Anlage (Solaranlage)"","
"0","  dev_hems    = ""Energiemanagementsystem"""
"0",")"
"0",""
"0","# 3) Statuslabels (Fragebogenlogik 1–4)"
"0","status_levels <- c("
"0","  ""Besitze ich"","
"0","  ""Plane ich in den nächsten 12 Monaten"","
"0","  ""Plane ich langfristig"","
"0","  ""Besitze ich nicht und plane keine Anschaffung"""
"0",")"
"0",""
"0","# 4) Long-Format + robuste Rekodierung (numerisch/character/labelled)"
"0","devices_long <- daten_analysis |>"
"0","  dplyr::select(dplyr::all_of(device_vars)) |>"
"0","  tidyr::pivot_longer("
"0","    cols = dplyr::everything(),"
"0","    names_to = ""device"","
"0","    values_to = ""status_raw"""
"0","  ) |>"
"0","  dplyr::mutate("
"0","    device_label = dplyr::if_else("
"0","      device %in% names(device_labels),"
"0","      unname(device_labels[device]),"
"0","      device"
"0","    ),"
"0","    status_code = suppressWarnings(as.integer(as.character(status_raw))),"
"0","    status = dplyr::case_when("
"0","      status_code == 1 ~ status_levels[1],"
"0","      status_code == 2 ~ status_levels[2],"
"0","      status_code == 3 ~ status_levels[3],"
"0","      status_code == 4 ~ status_levels[4],"
"0","      TRUE ~ ""Keine Angabe"""
"0","    ),"
"0","    status = factor(status, levels = c(status_levels, ""Keine Angabe""))"
"0","  ) |>"
"0","  dplyr::select(device_label, status)"
"0",""
"0","# 5) Übersichtstabelle (n / %)"
"0","device_table <- devices_long |>"
"0","  dplyr::count(device_label, status, name = ""Anzahl"") |>"
"0","  dplyr::group_by(device_label) |>"
"0","  dplyr::mutate(Anteil = round(Anzahl / sum(Anzahl) * 100, 1)) |>"
"0","  dplyr::ungroup() |>"
"0","  dplyr::arrange(device_label, match(status, levels(devices_long$status)))"
"0",""
"0","knitr::kable("
"0","  device_table,"
"0","  col.names = c(""Gerät"", ""Status"", ""Anzahl"", ""Anteil (%)""),"
"0","  align = c(""l"", ""l"", ""r"", ""r""),"
"0","  caption = ""Geräteausstattung der Stichprobe: Besitz und geplante Anschaffung steuerbarer Geräte."""
"0",")"
