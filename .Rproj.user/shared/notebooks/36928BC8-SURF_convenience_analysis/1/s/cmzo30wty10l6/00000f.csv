"0","#| label: step1-build-analysis-dataset"
"0","#| warning: false"
"0","#| message: false"
"0",""
"0","# ------------------------------------------------------------"
"0","# Schritt 1: Analyse-Datensatz erstellen (nur inhaltliche Variablen)"
"0","# - Whitelist-Ansatz: wir definieren, was INHALT ist, und droppen den Rest"
"0","# - erzeugt:"
"0","#   * daten_analysis (inhaltliche Variablen)"
"0","#   * drop_log (entfernte Variablen + Grund)"
"0","#   * var_map (Variable -> Inhaltsblock)"
"0","# ------------------------------------------------------------"
"0",""
"0","all_vars <- names(daten)"
"0",""
"0","# 1) Inhaltsvariablen definieren (Whitelist)"
"0","#    RandFreq = Experimentalbedingung (wichtig behalten!)"
"0","content_regex <- c("
"0","  ""^rand_freq$"",                # Experimentalbedingung"
"0","  ""^dev_"",                      # Geräteausstattung (DevBox, DevHeat, ...)"
"0","  ""^acc_(pre|post)$"",           # Akzeptanz vor/nach"
"0","  ""^part_(pre|post)_(real|hypo)$"",  # Teilnahmebereitschaft vor/nach"
"0","  ""^control_"",                  # Gerätesteuerung erlaubt? (ControlHeat, ...)"
"0","  ""^flex_"",                     # Eingriffspräferenzen / Flexibilität"
"0","  ""^fin_(form|structure|amount_year|amount_certainty)"", # Vergütung / WTP"
"0","  ""^restrictions_year$"",        # ggf. Filter/inhaltlich (im Fragebogen)"
"0","  ""^config_"",                   # Konfig-/Governance-Batterie"
"0","  ""^auto_trust"",                # Vertrauen / Info-Bedarf"
"0","  ""^info_content"",              # Info-Inhalte (InfoContent[1]...)"
"0","  ""^info_form"",                 # Info-Darstellung (InfoForm[1]...)"
"0","  ""^info_trust"",                # falls vorhanden (im Datensatz sichtbar)"
"0","  ""^motive$"",                   # Teilnahmemotiv"
"0","  ""^alter$"",                    # Alter"
"0","  ""^pers$"",                     # Haushaltsgröße (im Datensatz als Pers)"
"0","  ""^eink$"",                     # Einkommen"
"0","  ""^strom_rechnung$"",           # Stromrechnung"
"0","  ""^bild$"",                     # Bildung"
"0","  ""^geschl$"",                   # Geschlecht"
"0","  ""^wohn$"",                     # Wohnform"
"0","  ""^wohnort$""                   # Wohnort/Region"
"0",")"
"0",""
"0","content_keep <- all_vars["
"0","  stringr::str_detect(all_vars, paste(content_regex, collapse = ""|""))"
"0","]"
"0",""
"0","# 2) Technische Variablen (werden entfernt, falls nicht schon ausgeschlossen)"
"0","technical_regex <- c("
"0","  ""^id$"","
"0","  ""^submitdate$"","
"0","  ""^lastpage$"","
"0","  ""^startlanguage$"","
"0","  ""^seed$"","
"0","  ""^video_info$"","
"0","  ""^immersion$"","
"0","  ""^control_info$"","
"0","  ""^cheap_talk_script$"","
"0","  ""^redirect_info_end$"","
"0","  ""^survey_feedback$"","
"0","  ""^interviewtime$"","
"0","  ""^grouptime"",     # groupTime#### nach clean_names -> grouptime####"
"0","  ""time$"",           # alles, was auf _time endet"
"0","  ""^dev_.*_time$"""
"0",")"
"0",""
"0","technical_vars <- all_vars["
"0","  stringr::str_detect(all_vars, paste(technical_regex, collapse = ""|""))"
"0","]"
"0",""
"0","# 3) Endgültige Drop-Liste:"
"0","#    Alles, was nicht in content_keep ist, fliegt raus."
"0","#    (Das ist die strengste und sauberste Variante für Schritt 1.)"
"0","drop_vars <- setdiff(all_vars, content_keep)"
"0",""
"0","# 4) Analyse-Datensatz"
"0","daten_analysis <- daten |>"
"0","  dplyr::select(dplyr::all_of(content_keep))"
"0",""
"0","# 5) Mapping: Variable -> Inhaltsblock (für Dokumentation & Plan Schritt 2)"
"0","var_map <- tibble::tibble(variable = content_keep) |>"
"0","  dplyr::mutate("
"0","    block = dplyr::case_when("
"0","      stringr::str_detect(variable, ""^rand_freq$"") ~ ""03_experiment_randfreq"","
"0","      stringr::str_detect(variable, ""^dev_"") ~ ""01_ausstattung"","
"0","      stringr::str_detect(variable, ""^acc_pre$"") ~ ""02_akzeptanz_pre"","
"0","      stringr::str_detect(variable, ""^part_pre_"") ~ ""02_teilnahme_pre"","
"0","      stringr::str_detect(variable, ""^control_"") ~ ""04_geraeteauswahl_steuerung"","
"0","      stringr::str_detect(variable, ""^flex_"") ~ ""05_eingriffspraeferenzen"","
"0","      stringr::str_detect(variable, ""^fin_"") | variable == ""restrictions_year"" ~ ""06_verguetung_wtp"","
"0","      stringr::str_detect(variable, ""^config_"") | stringr::str_detect(variable, ""^auto_trust"") ~ ""07_vertrauen_kontrolle"","
"0","      stringr::str_detect(variable, ""^info_content"") | stringr::str_detect(variable, ""^info_form"") | stringr::str_detect(variable, ""^info_trust"") ~ ""08_information_app"","
"0","      stringr::str_detect(variable, ""^motive$"") ~ ""09_motive"","
"0","      stringr::str_detect(variable, ""^(alter|pers|eink|strom_rechnung|bild|geschl|wohn|wohnort)$"") ~ ""10_soziodemografie"","
"0","      TRUE ~ ""zz_unspecified"""
"0","    )"
"0","  ) |>"
"0","  dplyr::arrange(block, variable)"
"0",""
"0","# 6) Drop-Log erstellen (mit Hinweis, ob ""technisch erkannt"" oder ""nicht in Whitelist"")"
"0","drop_log <- tibble::tibble(variable = drop_vars) |>"
"0","  dplyr::mutate("
"0","    drop_reason = dplyr::case_when("
"0","      variable %in% technical_vars ~ ""technical/timing/meta"","
"0","      TRUE ~ ""not-in-content-whitelist"""
"0","    )"
"0","  ) |>"
"0","  dplyr::arrange(drop_reason, variable)"
"0",""
"0","# 7) Report-Ausgabe (kompakt)"
"0","# cat(""Dimensionen daten (raw): "", paste(dim(daten), collapse = "" x ""), ""\n"")"
"0","# cat(""Dimensionen daten_analysis: "", paste(dim(daten_analysis), collapse = "" x ""), ""\n"")"
"0","# cat(""Behaltene Variablen: "", ncol(daten_analysis), ""\n"")"
"0","# cat(""Entfernte Variablen: "", length(drop_vars), ""\n"")"
"0",""
"0","# 8) Logs speichern (optional, aber sehr empfehlenswert)"
"0","readr::write_csv(var_map,  file.path(TABLES_DIR, ""00_variable_mapping_blocks.csv""))"
"0","readr::write_csv(drop_log, file.path(TABLES_DIR, ""00_drop_log_step1.csv""))"
"0",""
"0","# 9) Logs im Report anzeigen (kurz, damit es nicht überläuft)"
"0","# knitr::kable("
"0","#   var_map |> dplyr::count(block, name = ""n_vars"") |> dplyr::arrange(block),"
"0","#   caption = ""Schritt 1: Anzahl inhaltlicher Variablen pro Inhaltsblock."""
"0","# )"
"0","# "
"0","# knitr::kable("
"0","#   head(drop_log, 25),"
"0","#   caption = ""Schritt 1: Beispielhaft entfernte Variablen (erste 25). Vollständige Liste als CSV gespeichert."""
"0","# )"
"0",""
