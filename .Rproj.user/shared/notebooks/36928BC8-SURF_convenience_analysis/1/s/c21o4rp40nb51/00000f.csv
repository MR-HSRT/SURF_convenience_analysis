"0",""
"0","#| label: qc-straightlining-batterywise"
"0","#| message: false"
"0","#| warning: false"
"0",""
"0","# ----------------------------"
"0","# Straightlining (batterie-spezifisch)"
"0","# Definition je Batterie:"
"0","# - mind. 60% beantwortet (mindestens 5 Items)"
"0","# - SD innerhalb Batterie = 0 (nur wenn >=2 gültige Werte vorhanden)"
"0","# Zusätzlich:"
"0","# - flag_straightline_any: TRUE wenn in mind. einer Batterie Straightlining"
"0","# ----------------------------"
"0",""
"0","# 1) Batterien definieren (Regex pro Batterie)"
"0","batteries <- list("
"0","  flex         = ""^(flex_)"","
"0","  config       = ""^(config_)"","
"0","  info_content = ""^(info_content_)"","
"0","  info_form    = ""^(info_form_)"""
"0",")"
"0",""
"0","# 2) Hilfsfunktion: batterie-spezifische Kennwerte für eine Zeile berechnen"
"0","row_straightline_metrics <- function(df_row, vars, min_answered) {"
"0","  x <- unlist(df_row[vars], use.names = FALSE)"
"0",""
"0","  # robuste Numerik (falls als character importiert)"
"0","  x <- suppressWarnings(as.numeric(x))"
"0",""
"0","  x_valid <- x[!is.na(x)]"
"0","  n_ans <- length(x_valid)"
"0",""
"0","  # SD nur sinnvoll bei >=2 gültigen Werten"
"0","  sd_x <- if (n_ans >= 2) stats::sd(x_valid) else NA_real_"
"0",""
"0","  flag <- isTRUE(n_ans >= min_answered && !is.na(sd_x) && sd_x == 0)"
"0",""
"0","  list(n_answered = n_ans, sd = sd_x, flag = flag)"
"0","}"
"0",""
"0","# 3) Für jede Batterie: Items ermitteln und Variablen anlegen"
"0","for (b in names(batteries)) {"
"0",""
"0","  vars_b <- names(surf_check)[stringr::str_detect(names(surf_check), batteries[[b]])]"
"0",""
"0","  # Wenn Batterie im Datensatz nicht vorhanden ist: saubere FALSE/NA-Spalten anlegen und weiter"
"0","  if (length(vars_b) == 0) {"
"0","    surf_check[[paste0(""n_answered_"", b)]] <- NA_integer_"
"0","    surf_check[[paste0(""sd_"", b)]] <- NA_real_"
"0","    surf_check[[paste0(""flag_straightline_"", b)]] <- FALSE"
"0","    next"
"0","  }"
"0",""
"0","  min_answered_b <- max(5, ceiling(length(vars_b) * 0.6))"
"0",""
"0","  # Rowwise-Berechnung pro Batterie"
"0","  res_b <- dplyr::rowwise(surf_check) |>"
"0","    dplyr::mutate("
"0","      .tmp = list(row_straightline_metrics("
"0","        df_row = dplyr::pick(dplyr::everything()),"
"0","        vars = vars_b,"
"0","        min_answered = min_answered_b"
"0","      )),"
"0","      !!paste0(""n_answered_"", b) := .tmp$n_answered,"
"0","      !!paste0(""sd_"", b) := .tmp$sd,"
"0","      !!paste0(""flag_straightline_"", b) := .tmp$flag"
"0","    ) |>"
"0","    dplyr::ungroup() |>"
"0","    dplyr::select(-.tmp)"
"0",""
"0","  surf_check <- res_b"
"0","}"
"0",""
"0","# 4) Gesamtflag: Straightlining in mindestens einer Batterie"
"0","flag_vars <- paste0(""flag_straightline_"", names(batteries))"
"0","flag_vars <- flag_vars[flag_vars %in% names(surf_check)]  # Sicherheit"
"0",""
"0","surf_check <- surf_check |>"
"0","  dplyr::mutate("
"0","    flag_straightline_any = dplyr::if_any(dplyr::all_of(flag_vars), ~ .x)"
"0","  )"
"0",""
"0",""
