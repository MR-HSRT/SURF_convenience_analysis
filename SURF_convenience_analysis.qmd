---
title: "Deskriptive Auswertung SURF Convenience Umfragedaten"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
execute:
  echo: false
  warning: false
  message: false
  cache: false
---

```{r}
#| label: setup
#| include: false

# ----------------------------
# 1) Pakete prüfen und laden
# ----------------------------
required_pkgs <- c(
  "here","readr","dplyr","tidyr","stringr","janitor","labelled",
  "psych","gtsummary","flextable","ggplot2","scales","broom","knitr"
)

missing_pkgs <- required_pkgs[!vapply(required_pkgs, requireNamespace, logical(1), quietly = TRUE)]
if (length(missing_pkgs) > 0) {
  stop(
    "Fehlende Pakete: ", paste(missing_pkgs, collapse = ", "),
    "\nBitte einmalig installieren (nicht im Quarto-Renderprozess), z.B.:",
    "\ninstall.packages(c(\"", paste(missing_pkgs, collapse = "\", \""), "\"))"
  )
}

invisible(lapply(required_pkgs, function(pkg) {
  suppressPackageStartupMessages(library(pkg, character.only = TRUE))
}))

# ----------------------------
# 2) Ordnerstruktur erstellen
# ----------------------------
dir.create(here::here("data", "raw"),        recursive = TRUE, showWarnings = FALSE)
dir.create(here::here("data", "processed"),  recursive = TRUE, showWarnings = FALSE)
dir.create(here::here("outputs", "plots"),   recursive = TRUE, showWarnings = FALSE)
dir.create(here::here("outputs", "tables"),  recursive = TRUE, showWarnings = FALSE)

# ----------------------------
# 3) Reproduzierbarkeit
# ----------------------------
set.seed(1234)

PLOTS_DIR  <- here::here("outputs", "plots")
TABLES_DIR <- here::here("outputs", "tables")

# ----------------------------
# 4) .gitignore sicherstellen
# ----------------------------
gitignore_path <- here::here(".gitignore")

gitignore_content <- c(
  "# --- R / RStudio ---",
  ".Rproj.user/",
  ".Rhistory",
  ".RData",
  ".Ruserdata",
  "",
  "# --- Data files ---",
  "*.csv",
  "",
  "# --- Quarto ---",
  "*_cache/",
  "*_files/",
  "",
  "# --- Private data (NEVER commit) ---",
  "data/raw/",
  "data/processed/",
  "",
  "# --- Local secrets ---",
  ".env"
)

if (!file.exists(gitignore_path)) {
  writeLines(gitignore_content, gitignore_path)
} else {
  existing_raw  <- readLines(gitignore_path, warn = FALSE)
  existing_trim <- trimws(existing_raw)

  to_add <- gitignore_content[!gitignore_content %in% existing_trim]

  if (length(to_add) > 0) {
    writeLines(c(existing_raw, to_add), gitignore_path)
  }
}

```

```{r}
#| label: data-import
#| include: false

# ----------------------------
# 1) Datenimport
# ----------------------------

daten <- readr::read_delim(
  here::here("data", "raw", "results-survey739381.csv"),
  delim = ";",
  locale = readr::locale(encoding = "UTF-8", decimal_mark = ","),
  na = c("", "NA")
)

daten <- janitor::clean_names(daten)

cat(
  paste0(
    sprintf(
      "%-30s | %-20s | missing: %-6s | unique: %-6s",
      names(daten),
      vapply(daten, function(x) paste(class(x), collapse = ", "), character(1)),
      vapply(daten, function(x) sum(is.na(x)), integer(1)),
      vapply(daten, function(x) length(unique(x)), integer(1))
    ),
    collapse = "\n"
  )
)

```

```{r}
#| label: clean-variables

# Alle Variablen, die NUR technische Metadaten sind
drop_patterns <- c(
  "^id$",
  "^submitdate$",
  "^lastpage$",
  "^startlanguage$",
  "^seed$",
  "^rand_freq$",
  "^video_info$",
  "^immersion$",
  "^control_info$",
  "^cheap_talk_script$",
  "^restrictions_year$",
  "^redirect_info_end$",
  "^survey_feedback$",
  "^interviewtime$",
  "^group_time",
  "_time$"
)

drop_vars <- names(daten)[
  stringr::str_detect(names(daten), paste(drop_patterns, collapse = "|"))
]

# Datensatz bereinigen
daten_clean <- daten |> 
  dplyr::select(-dplyr::all_of(drop_vars))

# Übersicht
cat("Entfernte Variablen:\n")
cat(paste(drop_vars, collapse = ", "))
cat("\n\nDimensionen vorher: ", paste(dim(daten), collapse = " x "))
cat("\nDimensionen nachher: ", paste(dim(daten_clean), collapse = " x "))

readr::write_csv(daten_clean, here::here("data", "processed", "surf_clean.csv"))

```


